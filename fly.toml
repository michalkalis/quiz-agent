# Fly.io configuration for Quiz Agent API
# Deployment: fly launch (first time) or fly deploy (updates)

app = "quiz-agent-api"
primary_region = "iad"  # US East - change to closest region for your users

# Build configuration
[build]
  dockerfile = "Dockerfile"

# Environment variables (non-sensitive)
[env]
  PORT = "8002"
  PYTHONUNBUFFERED = "1"
  CHROMA_PERSIST_DIR = "/app/data/chroma_data"
  SQLITE_PATH = "/app/data/ratings.db"
  TTS_CACHE_DIR = "/app/data/tts_cache"
  TTS_CACHE_MAX_MB = "100"

# HTTP service configuration
[http_service]
  internal_port = 8002
  force_https = true
  auto_stop_machines = true    # Cost savings: stop when idle
  auto_start_machines = true   # Auto-start on request
  min_machines_running = 0     # Scale to zero when idle (free tier friendly)
  processes = ["app"]

  # Health checks
  [[http_service.checks]]
    grace_period = "10s"
    interval = "30s"
    method = "GET"
    timeout = "5s"
    path = "/api/v1/health"

# Persistent volume mount for data persistence
[mounts]
  source = "quiz_agent_data"
  destination = "/app/data"

# Virtual machine configuration
[[vm]]
  cpu_kind = "shared"
  cpus = 1
  memory_mb = 512  # Start small, can scale up if needed

# Deployment instructions:
#
# 1. Install Fly.io CLI:
#    curl -L https://fly.io/install.sh | sh
#
# 2. Login:
#    fly auth login
#
# 3. Create volume (first time only):
#    fly volumes create quiz_agent_data --size 3 --region iad
#
# 4. Set secrets:
#    fly secrets set OPENAI_API_KEY=sk-proj-...
#
# 5. Deploy:
#    fly deploy
#
# 6. Check status:
#    fly status
#    fly logs
#
# 7. Access app:
#    https://quiz-agent-api.fly.dev/api/v1/health
#    https://quiz-agent-api.fly.dev/docs  # API documentation
