name: iOS CI

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'apps/ios-app/**'
      - '.github/workflows/ios-ci.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'apps/ios-app/**'
      - '.github/workflows/ios-ci.yml'

jobs:
  build-and-test:
    name: Build and Test iOS App
    runs-on: macos-15  # macOS 15 with Xcode 16+

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_16.0.app/Contents/Developer || sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Show available simulators
        run: xcrun simctl list devices available

      - name: Build iOS app
        run: |
          cd apps/ios-app/CarQuiz
          xcodebuild clean build \
            -scheme CarQuiz \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Run unit tests
        run: |
          cd apps/ios-app/CarQuiz
          xcodebuild test \
            -scheme CarQuiz \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -enableCodeCoverage YES

      - name: Archive test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-test-results
          path: |
            ~/Library/Logs/DiagnosticReports/
            ~/Library/Developer/Xcode/DerivedData/*/Logs/Test/*.xcresult
          retention-days: 7

  lint-swift:
    name: Lint Swift Code
    runs-on: macos-15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Run SwiftLint
        run: |
          cd apps/ios-app/CarQuiz/CarQuiz
          swiftlint lint --strict || echo "SwiftLint not configured, skipping"

  verify-api-models:
    name: Verify API Models Match Backend
    runs-on: ubuntu-latest
    needs: []  # Run in parallel with iOS build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Install backend dependencies
        run: |
          uv pip install --system -e apps/quiz-agent
          uv pip install --system -e packages/shared

      - name: Start backend to generate OpenAPI spec
        env:
          OPENAPI_API_KEY: ${{ secrets.OPENAI_API_KEY || 'sk-test-key' }}
        run: |
          cd apps/quiz-agent
          uvicorn app.main:app --host 0.0.0.0 --port 8002 &
          sleep 5

      - name: Download OpenAPI spec
        run: |
          curl -f http://localhost:8002/openapi.json -o openapi-current.json
          echo "âœ… OpenAPI spec downloaded"

      - name: Comment on PR with OpenAPI spec location
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ“‹ OpenAPI spec generated. Download from backend at: `curl http://localhost:8002/openapi.json > apps/ios-app/openapi.yaml`\n\nVerify iOS Codable models match the spec.'
            })

      - name: Upload OpenAPI spec
        uses: actions/upload-artifact@v4
        with:
          name: openapi-spec-for-ios
          path: openapi-current.json
          retention-days: 7
